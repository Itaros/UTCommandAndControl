<?xml version="1.0" encoding="UTF-8" ?>
<aiscript name="ut.cac.com.captain.mining" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd">
  <!--
    Script which sends the Ship mining in a certain Zone for certain Wares and when done with this sells these Wares at the Homebase
  -->
  <params>
    <param name="params" default="false" comment="pass a single Table filled with the wanted param Values here to make calls via list possible (always has priority)"/>
    <param name="mininglist" default="null" />
    <param name="zone" default="null" />
  </params>
  <interrupts>
    <handler comment="Print Script Vars">
      <conditions>
        <event_object_signalled object="this" param="'print script vars to logfile'"/>
      </conditions>
      <actions>
        <debug_text filter="general" text="'\n
        Captain Name ' + this.knownname + ' at Time ' + player.age + '\n
        ut.cac.com.captain.mining Script Values:\n
        $mininglist = ' + $mininglist + '\n
        $zone = ' + $zone"/>
      </actions>
    </handler>
  </interrupts>
  <attention min="unknown">
    <actions>
      <do_if value="$params">
        <do_if value="$params.$mininglist?">
          <set_value name="$mininglist" exact="$params.$mininglist"/>
        </do_if>
        <do_if value="$params.$zone?">
          <set_value name="$zone" exact="$params.$zone"/>
        </do_if>
      </do_if>
      <remove_value name="$params"/>
      
      <set_command command="command.mining" param="$zone"/>
      <set_command_action commandaction="commandaction.calculating" />
      
      <wait min="5s" max="15s" />
      
      <do_if value="this.ship.cargo.capacity" max="0">
        <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Ship has Cargo Capacity of %4 - aborting'.[player.age,this.name,this.container.name,this.ship.cargo.capacity]"/>
        <return/>
      </do_if>
      <do_if value="not this.ship.commander.exists">
        <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Mining without commander not supported yet! - aborting'.[player.age,this.name,this.container.name]"/>
        <return/>
      </do_if>
      <set_value name="$homebase" exact="this.ship.commander" />
      <do_if value="this.ship.units.collect.count" exact="0">
        <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Mining ship does not have any units for collecting! - aborting'.[player.age,this.name,this.container.name]"/>
        <return/>
      </do_if>
      <do_if value="$mininglist == null">
        <set_value name="$mininglist" exact="this.ship.warebasket.list" />
      </do_if>
      <do_if value="$mininglist.count" exact="0">
        <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Mining ship does not have Wares in Warebasket! - aborting'.[player.age,this.name,this.container.name]"/>
        <return/>
      </do_if>
      <do_if value="(this.ship.cargo.free)f / this.ship.cargo.capacity" max="0.5">
        <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Less than half of Cargo free, empty Ship first! - aborting'.[player.age,this.name,this.container.name]"/>
        <return/>
      </do_if>
      
      <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Starting new mining Run'.[player.age,this.name,this.container.name]"/>
      
      <!-- make virtual Reservations for all the Wares we can mine (half amount we can carry) -->
      <do_all exact="$mininglist.count" counter="$i">
        <add_ware_reservation object="this.ship.commander" entity="this" ware="$mininglist.{$i}" amount="this.ship.cargo.{$mininglist.{$i}}.free/2" duration="2h" virtual="true" />
      </do_all>
      <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Reserved Wares:\n%4'.[player.age,this.name,this.container.name,$mininglist]"/>
      
      <!-- Go to Ordered Zone -->
      <do_if value="this.zone != $zone">
        <set_command_action commandaction="commandaction.flyingto" param="$zone"/>
        <run_script name="'move.generic'">
          <param name="destination" value="$zone" />
          <param name="endintargetzone" value="true" />
        </run_script>
      </do_if>
      <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Reached Zone where we mine'.[player.age,this.name,this.container.name]"/>
      
      <!-- start Mining -->
      <run_script name="'mining.ship.collect'">
        <param name="zone" value="$zone"/>
        <param name="ware" value="$mininglist.{1}"/>
        <param name="secwares" value="$mininglist"/>
        <param name="debugchance" value="0"/>
      </run_script>
      <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Done mining, recalling Drones'.[player.age,this.name,this.container.name]"/>
      
      <run_script name="'lib.recall.drones'"/>
      <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Done Recalling Drones'.[player.age,this.name,this.container.name]"/>
      
      <!-- Check what we got effectively and plan Trade Orders to get the Wares to the Commander -->
      <do_all exact="$mininglist.count" counter="$i">
        <remove_ware_reservation object="$homebase" entity="this" virtual="true" ware="$mininglist.{$i}" />
        <do_if value="this.ship.cargo.{$mininglist.{$i}}.count">
          <create_trade_offer name="$buyoffer" buyer="this.ship.commander" object="this.ship.commander" amount="this.ship.cargo.{$mininglist.{$i}}.count" ware="$mininglist.{$i}" price="0Cr" playeronly="true"/>
          <add_sell_order object="this.ship" trade="$buyoffer" amount="$buyoffer.amount" price="0Cr"/>
          <append_to_list name="this.$orderlist" exact="table[$script='ut.cac.com.captain.performsingletraderun',$repeat=0,$undock=false]"/>
          <remove_trade_offer object="this.ship.commander" tradeoffer="$buyoffer"/>
        </do_if>
      </do_all>
      <!-- when last Ware is unloaded we want to undock -->
      <set_value name="this.$orderlist.{this.$orderlist.count}.$undock" exact="true"/>
      <append_to_list name="this.$orderlist" exact="table[$script='ut.cac.com.captain.refuel',$repeat=0]"/>
      <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Done Adding Trade Orders, exitig'.[player.age,this.name,this.container.name]"/>
      
    </actions>
  </attention>
  <on_abort>
    <do_if value="$homebase.exists">
      <remove_ware_reservation object="$homebase" entity="this" virtual="true" />
    </do_if>
  </on_abort>
</aiscript>