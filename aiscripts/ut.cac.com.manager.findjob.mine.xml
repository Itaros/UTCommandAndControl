<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.com.manager.findjob.mine" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd" version="1">
  <params>
    <param name="params" default="false" comment="pass a single Table filled with the wanted param Values here to make calls via list possible (always has priority)"/>
    <param name="entity" default="false" comment="Entity who needs (Mine)Orders (NOT as Ship)"/>
    <param name="range" default="false" comment="List of Spaces where the Ressource should be found inside (lower index, higher prio)"/>
    <param name="mininglist" default="false" comment="List of Ressources to Mine, where first item is the really importat one but the others are fine, too"/>
  </params>
  <interrupts>
    <handler comment="Print Script Vars">
      <conditions>
        <event_object_signalled object="this" param="'print script vars to logfile'"/>
      </conditions>
      <actions>
        <debug_text filter="general" text="'\nManager Name ' + this.knownname + ' at Time ' + player.age + ' Script Values:\n
$entity  = ' + $entity + '\n
$mininglist = ' + $mininglist"/>
      </actions>
    </handler>
  </interrupts>
  <init>

  </init>
  <attention min="unknown">
    <actions>
      <do_if value="$params">
        <do_if value="$params.$entity?">
          <set_value name="$entity" exact="$params.$entity"/>
        </do_if>
        <do_if value="$params.$mininglist?">
          <set_value name="$mininglist" exact="$params.$mininglist"/>
        </do_if>
        <remove_value name="$params"/>
      </do_if>
      
      <!-- Input Validation -->
      <do_if value="not $entity.exists">
        <debug_text filter="error" text="'%1 %2 %3 No Entity passed to give Mine Orders to - aborting'.[player.age,this.name,this.container.name]"/>
        <return value="false"/>
      </do_if>
      <do_if value="not $range">
        <debug_text filter="error" text="'%1 %2 %3 No Range passed to check for Ressources - aborting'.[player.age,this.name,this.container.name]"/>
        <return value="false"/>
      </do_if>
      <do_if value="not $mininglist.count">
        <debug_text filter="error" text="'%1 %2 %3 No Ressources list passed to find Mining Zone - aborting'.[player.age,this.name,this.container.name]"/>
        <return value="false"/>
      </do_if>
      
      
      <set_command_action commandaction="commandaction.searchingresources"/>
      <wait min="3s" max="15s" />
      <!-- check how much we actually need (either needed by Station or limited by Storage) -->
      <get_ware_reservation ware="$mininglist.{1}" object="this.container" result="$incomingamount"/>
      <set_value name="$amount" exact="[this.container.cargo.{$mininglist.{1}}.target - this.container.cargo.{$mininglist.{1}}.count - $incomingamount , $entity.ship.cargo.{$mininglist.{1}}.free].min"/>
      <!-- $zone is a Return Value!!! -->
      <do_all exact="$range.count" counter="$i" reverse="false">
        <do_if value="$range.{$i}.exists">
          <find_closest_resource zone="$zone" ware="$mininglist.{1}" minamount="$amount" refobject="$range.{$i}"/>
          <!-- found Ressource in Range - exit with success -->
          <do_if value="$zone.hascontext.{$range.{$i}}">
            <debug_text filter="general" chance="this.$debug *100" text="'%1 %2 %3 Found wanted Ressource in Range:\nRange: %4 - Zone: %5'.[player.age,this.name,this.container.name,$range.{$i}.knownname,$zone]"/>
            <signal_objects object="$entity.ship" param="'new order'" param2="table[$script='ut.cac.com.captain.mining',$displayname='Mining in %1 (Manager)'.[$zone.knownname],$zone=$zone,$mininglist=$mininglist,$interruptable=false]"/>
            <return value="true"/>
          </do_if>
        </do_if>
      </do_all>
      
      
      <debug_text filter="general" chance="this.$debug *100" text="'%1 %2 %3 No Ressources found in Range - returning'.[player.age,this.name,this.container.name]"/>
      <return value="false"/>
    </actions>
  </attention>
</aiscript>
