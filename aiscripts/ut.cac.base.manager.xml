<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.base.manager" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd" version="1">
  <params/>
  <interrupts>
    <handler comment="Print Script Vars">
      <conditions>
        <event_object_signalled object="this" param="'print script vars to logfile'"/>
      </conditions>
      <actions>
        <debug_text filter="general" text="'\n
        Manager Name ' + this.knownname + ' at Time ' + player.age + ' Script Values:\n
        this.$legality = ' + this.$legality + '\n
        this.$orderlist = ' + this.$orderlist + '\n
        $bug = ' + $bug + '\n
        NOTE: ONLY VALUES I CREATED MYSELF INCLUDED - nothing from C+P Code Snippets
        '"/>
      </actions>
    </handler>
    <handler comment="Money Updated Handler">
      <conditions>
        <event_object_money_updated object="this"/>
      </conditions>
    </handler>
    <handler comment="Order Request Handler">
      <conditions>
        <check_any>
          <event_object_signalled object="this" param="'request orders'"/>
        </check_any>
      </conditions>
      <actions>
        <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 %4:\nevent.param= %5 event.param2= %6 event.param3= %7'.[player.age,this.name,this.container.name,event.name,event.param,event.param2,event.param3]"/>
        <do_if value="true" comment="for when this is a Trading or mining Ship to give it Trade or Mining Orders - the only ones available currently." >
          <!-- ToDo: be a bit more considerate about where to put this order - dont move orders from other requesters down for example or look if the manager already intends to look for trades for this Ship -->
          <set_value name="this.$orderlist.{2}" exact="table[$script='ut.cac.com.manager.findjob.trade',$repeat=false,$entity=event.param2]" operation="insert"/>
        </do_if>
        <!-- Other possible Orders the Manager can give to be added here -->
      </actions>
    </handler>
  </interrupts>
  <init>
  </init>
  <attention min="unknown">
    <actions>
      <label name="init"/>
      
      <!-- set up legality levels:
      3 - no goods which are considered illegal anywhere
      2 - no goods which are considered illegal in this Zone or Sector
      1 - no goods which are considered illegal in this Zone or Sector taking licenses into account (default for now; will change to 3 when interface is ready)
      0 - trades with everything - wheter legal or illegal
      -->
      <do_if value="not this.$legality?">
        <set_value name="this.$legality" exact="1"/>
      </do_if>
      
      <!-- set up orderlist -->
      <do_if value="not this.$orderlist?">
        <create_list name="this.$orderlist"/>
      </do_if>
      
      <!--immediately allow Zone Trading and Mining -->
        <set_value name="$next_zonetrade" exact="player.age"/>
        <set_value name="$next_miningstep" exact="player.age"/>
      
      <!-- Chance of this Script to bug out to improve Feedback -->
      <!-- feel free to set it to 0, but please dont spoil this trick and write a few comments in the Mod Topics :) -->
      <set_value name="$bug" exact="0"/>
      
      <!-- add Fuelcells as Trade Ware so Energy Freighters will buy it and put it into the Station Cargo -->
      <add_tradeware object="this.container" ware="ware.fuelcells" allowbuy="true" allowsell="false" />
      
      
      <!-- register Subordinates - see event Handlers for actual adding procedure -->
      <!-- also add order to manager to look up their first assignment -->
      <do_all exact="this.container.subordinates.{this.type}.count" counter="$i">
        <signal_objects object="this" param="this.container.subordinates.{this.type}.{$i}" param2="'register subordinate'" />
        <wait exact="1ms"/>
      </do_all>
      
      <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 init finished\nSet Values: this.$legalitiy= %3 $bug= %4 , Fuelcells added as Tradeware, Signalled %5 Subordinates'.[player.age,$actor.name,this.$legality,$bug,this.container.subordinates.{this.type}.count]"/>
      
      
      <label name="start with orderlist"/>
      
      <!-- fulfill all Orders in List in their order -->
      <do_while value="this.$orderlist.count gt 0">
        <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Command Queue: \n%4'.[player.age,this.name,this.container.name,this.$orderlist]"/>
        <set_value name="$order" exact="this.$orderlist.{1}" />
        <do_if value="typeof $order == datatype.table">
          <remove_value name="$repeat"/>
          <run_script name="$order.$script">
            <param name="params" value="$order" />
            <save_retval name="repeat" variable="$repeat"/>
          </run_script>
          <do_if value="not $repeat"/><!-- case 0/false - dont copy/re-execute the Order -->
          <do_elseif value="$repeat == 1" >
            <!-- case 1/true -> copy Order to the end of the list -->
            <append_to_list name="this.$orderlist" exact="$order"/>
          </do_elseif>
          <do_else>
            <!-- case other number -> copy Order to specified position (except 0/false, which says dont repeat) -->
            <set_value name="this.$orderlist.{$repeat}" exact="$order" operation="insert"/>
          </do_else>
        </do_if>
        <!-- remove current Order so we can get to the next one - after that wait a split-second to prevent Freezes should something go wrong-->
        <remove_value name="this.$orderlist.{1}" />
        <wait exact="100ms"/>
      </do_while>
      
      <!-- no outstanding direct orders - look up what makes sense and append it to Orderlist -->
      
      <label name="find job"/>
      
      <!-- check if we have gasses as ressource and can mine them directly (!!!Testing needed!!! )-->
      <do_if value="player.age gt $next_miningstep">
        <set_value name="$next_miningstep" exact="player.age + 2min"/>
        <create_list name="$mineable_ressources"/>
        <do_all exact="this.container.resources.list.count" counter="$i">
          <set_value name="$ware" exact="this.container.resources.list.{$i}"/>
          <do_if value="$ware.tags.indexof.{tag.minable} and this.container.cargo.{$ware}.count lt this.container.cargo.{$ware}.target">
            <get_resource_gatherrate name="$gatherrate" refobject="this.container" ware="$ware" zone="this.zone" />
            <do_if value="$gatherrate">
              <append_to_list name="$mineable_ressources" exact="$ware"/>
            </do_if>
          </do_if>
        </do_all>
        <do_if value="$mineable_ressources.count">
          <set_value name="$next_miningstep" exact="player.age + 2min"/>
          <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Found Mineable Ressources: \n%4'.[player.age,this.name,this.container.name,$mineable_ressources]"/>
          <append_to_list name="this.$orderlist" exact="table[$script='ut.cac.com.manager.gatherressources',$repeat=false,$wareslist=$mineable_ressources]" chance="0"/>
        </do_if>
      </do_if>
      
      <!-- if there is not much else to do - do Zonetrade (POSSIBLY TIME INTENSIVE) -->
      <do_if value="this.$orderlist.count lt 2 and player.age gt $next_zonetrade">
        <set_value name="$next_zonetrade" exact="player.age + 2min"/>
        <append_to_list name="this.$orderlist" exact="table[$script='ut.cac.com.manager.zonetrade',$repeat=false]"/>
      </do_if>
      
      <do_if value="this.$orderlist.count == 0">
        <append_to_list name="this.$orderlist" exact="table[$script='ut.cac.microorder',$order='wait exact signal',$time=1min,$signalobject=this,$signalparam='request orders',$repeat=0]"/>
      </do_if>
      
      <resume label="start with orderlist"/>
      
    </actions>
  </attention>
  <on_abort>
    <remove_tradeware object="this.container" ware="ware.fuelcells"/>
  </on_abort>
</aiscript>
