<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.base.manager" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd" version="1">
  <params/>
  <interrupts>
    <handler comment="Print Script Vars">
      <conditions>
        <event_object_signalled object="this" param="'print script vars to logfile'"/>
      </conditions>
      <actions>
        <debug_text filter="general" text="'\n
        Manager Name ' + this.knownname + ' at Time ' + player.age + ' Script Values:\n
        this.$ut_cac_settings = ' + this.$ut_cac_settings + '\n
        this.$orderlist = ' + this.$orderlist + '\n
        $bug = ' + $bug + '\n
        this.$idle_subordinates = ' + this.$idle_subordinates"/>
      </actions>
    </handler>
    <handler comment="Money Updated Handler">
      <conditions>
        <event_object_money_updated object="this"/>
      </conditions>
    </handler>
    <handler comment="Order Request Handler - uses this.$idle_subordinates to let the manager finish what he is currently doing but not let him forget about outstanding order requests">
      <conditions>
        <check_any>
          <event_object_signalled object="this" param="'request orders'"/>
        </check_any>
      </conditions>
      <actions>
        <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 %4:\nevent.param= %5 event.param2= %6 event.param3= %7'.[player.age,this.name,this.container.name,event.name,event.param,event.param2,event.param3]"/>
        <add_to_group groupname="this.$idle_subordinates" object="event.param2"/>
        <!-- in case a script checks for the orderlist length for pausing/termination add a do-nothing order -->
        <append_to_list name="this.$orderlist" exact="table[$script='ut.cac.microorder',$order=null]"/>
      </actions>
    </handler>
    <handler comment="Zonetrade Cleanup">
      <conditions>
        <check_any>
          <event_trade_order_cancelled buyer="this.container"/>
          <event_trade_order_completed buyer="this.container"/>
        </check_any>
      </conditions>
      <actions>
        <do_if value="event.param == this.$ut_cac_settings.$currenttrade">
          <debug_text filter="error" text="'%1 %2 %3 Manager Zonetrade %4 finally finished!! IT WORKS! PLEASE TELL ME WHEN YOU SEE THIS!'.[player.age,this.name,this.container.name,$finalselloffer] )"/>
          <remove_ware_reservation object="this.container" entity="this" ware="event.param.ware"/>
          <set_value name="entity.$ut_cac_settings.$currenttrade" exact="null"/>
        </do_if>
      </actions>
    </handler>
  </interrupts>
  <init>
  </init>
  <attention min="unknown">
    <actions>
      <label name="init"/>
      
      <!-- set up orderlist -->
      <do_if value="not this.$orderlist?">
        <create_list name="this.$orderlist"/>
      </do_if>
      
      <!-- set up Idle Subordinates Group for other Objects to register to -->
      <do_if value="not this.$idle_subordinates?">
        <create_group groupname="this.$idle_subordinates"/>
      </do_if>
      
      <!-- Set up mining Command (must re-use the same table since i am also using it to store persistent Values) - only $mininglist is updated with every iteration so the miningscript knows what is needed -->
      <set_value name="$miningorder" exact="table[$script='ut.cac.com.manager.gatherressources',$displayname='Gather Ressources (default)',$interruptable=false]"/>
      
      <!--immediately allow Zone Trading and Mining -->
      <set_value name="$next_zonetrade" exact="player.age"/>
      <set_value name="$next_miningstep" exact="player.age"/>
      
      <!-- add Fuelcells as Trade Ware if Sctation has Cargo for them so Energy Freighters will buy it and put it into the Station Cargo for Refueling of Station Ships -->
      <!--do_if value="this.container.cargo.{ware.fuelcells}.free gt 0">
        <add_tradeware object="this.container" ware="ware.fuelcells" allowbuy="true" allowsell="false"/>
      </do_if-->
      
      
      <!-- register Subordinates - see event Handlers for actual adding procedure -->
      <do_all exact="this.container.subordinates.{this.type}.count" counter="$i">
        <signal_objects object="this" param="this.container.subordinates.{this.type}.{$i}" param2="'register subordinate'" />
        <wait exact="1ms"/>
      </do_all>
      
      <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 init finished\nSet Values: this.$legalitiy= %3, Signalled %4 Subordinates'.[player.age,this.name,this.$legality,this.container.subordinates.{this.type}.count]"/>
      
      
      <label name="start with orderlist"/>
      
      <!-- fulfill all Orders in List in their order -->
      <do_while value="this.$orderlist.count gt 0">
        <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Command Queue: \n%4'.[player.age,this.name,this.container.name,this.$orderlist]"/>
        <set_value name="$order" exact="this.$orderlist.{1}" />
        <do_if value="typeof $order == datatype.table">
          <set_value name="$order.$interruptable" exact="false"/>
          <run_script name="$order.$script">
            <param name="params" value="$order" />
          </run_script>
        </do_if>
        <!-- If current first Order is still the same as before executing it - remove it from Orderlist so we can continue with the next one - after that wait a split-second to prevent Freezes should something go wrong -->
        <!-- (if its a diffrent Order the first Order was moved or replaced, which should cause an abort of it and a the new first Order should be executed immediately) -->
        <do_if value="this.$orderlist.{1} == $order">
          <remove_value name="this.$orderlist.{1}" />
        </do_if>
        <wait exact="100ms"/>
      </do_while>
      
      <!-- no outstanding direct orders - look up what makes sense and append it to Orderlist -->
      
      <label name="find job"/>
      
      <!-- check if we have Idle Subordinates and find Jobs for them (priority, immediately start with finding orders fo them) -->
      <do_if value="this.$idle_subordinates.count gt 0">
        <do_all exact="this.$idle_subordinates.count" counter="$i">
          <append_to_list name="this.$orderlist" exact="table[$script='ut.cac.com.manager.findjob',$displayname='Find Job (Subordinate Request)',$entity=this.$idle_subordinates.{$i},$interruptable=false]"/>
        </do_all>
        <resume label="start with orderlist"/>
      </do_if>
      
      <!-- check if we have gasses as ressource and can mine them directly -->
      <do_if value="player.age gt $next_miningstep">
        <set_value name="$next_miningstep" exact="player.age + 1min"/>
        <create_list name="$mineable_ressources"/>
        <do_all exact="this.container.resources.list.count" counter="$i">
          <set_value name="$ware" exact="this.container.resources.list.{$i}"/>
          <do_if value="$ware.tags.indexof.{tag.minable} and this.container.cargo.{$ware}.count lt this.container.cargo.{$ware}.target and this.zone.yield.indexof.{$ware}">
            <get_resource_gatherrate name="$gatherrate" refobject="this.container" ware="$ware" zone="this.zone" />
            <do_if value="$gatherrate">
              <append_to_list name="$mineable_ressources" exact="$ware"/>
            </do_if>
          </do_if>
        </do_all>
        <do_if value="$mineable_ressources.count or ( $miningorder.gatherware? and $miningorder.$gatherstart? and $miningorder.$gatherrate? )">
          <debug_text filter="general" chance="this.$debug * 100" text="'%1 %2 %3 Found Mineable Ressources: \n%4'.[player.age,this.name,this.container.name,$mineable_ressources]"/>
          <set_value name="$miningorder.$wareslist" exact="$mineable_ressources"/>
          <set_value name="$miningorder.$next_call" exact="1min"/>
          <append_to_list name="this.$orderlist" exact="$miningorder"/>
        </do_if>
        <do_else>
          <set_value name="$next_miningstep" exact="player.age + 2min"/>
        </do_else>
      </do_if>
      
      <!-- if there is not much else to do - do Zonetrade (POSSIBLY TIME INTENSIVE) -->
      <do_if value="this.$orderlist.count lt 1 and player.age gt $next_zonetrade and not entity.$ut_cac_settings.$currenttrade">
        <set_value name="$next_zonetrade" exact="player.age + 7min"/>
        <append_to_list name="this.$orderlist" exact="table[$script='ut.cac.com.manager.zonetrade',$displayname='Perform Zonetrade (default)',$repeat=false,$interruptable=true]"/>
      </do_if>
      
      <do_if value="this.$orderlist.count == 0">
        <append_to_list name="this.$orderlist" exact="table[$script='ut.cac.microorder',$displayname='Wait for Orders (default)',$order='wait order',$time=5min,$interruptable=true]"/>
      </do_if>
      
      <resume label="start with orderlist"/>
      
    </actions>
  </attention>
  <on_abort>
    <do_if value="this.container.tradewares.{ware.fuelcells}.exists">
      <remove_tradeware object="this.container" ware="ware.fuelcells"/>
    </do_if>
  </on_abort>
</aiscript>
