<?xml version="1.0" encoding="UTF-8" ?>
<mdscript name="UT_CAC_Captain" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/md.xsd">

  <cues>

    <cue name="Main" instantiate="true" namespace="this">
      <conditions>
        <event_cue_signalled cue="this"/>
      </conditions>
      <actions>
        <!-- set up Variables -->
        <set_value name="$actor" exact="event.param" />
        <set_value name="$actor.$debug" exact="false" chance="(not $actor.$debug?)*100" comment="default value if not already set"/>
        <set_value name="$actor.$pesterlevel" exact="60" comment="default value for pestering the Player about issues"/>
        <set_value name="$actor.$loglevel" exact="0" comment="default value for Playerlog verbosity"/>
        <!-- cancel Vanilla Dialogue -->
        <signal_objects object="$actor" param="'cancel Vanilla dialogue tree'"/>
        <set_comm_handler actor="$actor" customhandler="true" />
        <!-- From now on, only this instance tree is responsible for handling the entity conversation - only available for the Player, it will manage Personal costs, Dialogue Tree and Settings Config (interface to AIscripts are blackboard Vars and Signals)-->
        <!-- start default Scripts -->
        <debug_text filter="general" chance="$actor.$debug*100" text="'%1 now uses UT CAC comm handlers'.[$actor.name]" />
      </actions>
      <cues>
        <cue name="Delayed_scriptstart">
          <delay exact="100ms"/>
          <actions>
            <!-- ToDo: check if the Scripts are already executing the right Command and give them commands for a smooth takeover -->
            <start_script object="$actor" name="'ut.cac.base.captain'"/>
          </actions>
        </cue>
        <!--cue name="Payment" ref="md.UT_CAC_Lib.Payment">
          <param name="actor" value="$actor"/>
        </cue-->
        
        <!--cue name="NormalActor" onfail="cancel">
          <conditions>
            <check_value value="not $actor.iscontrolentity" />
          </conditions>
          <cues>
            <cue name="EngineerTimeout" ref="md.GenericMissions.PlatformActor">
              <param name="BaseCue" value="OnPlatformPopulation_Engineer" />
              <param name="Actor" value="$actor" />
              <param name="TimeoutMin" value="10min"/>
              <param name="TimeoutMax" value="20min"/>
            </cue>
          </cues>
        </cue>

        <cue name="ControlEntity" onfail="cancel">
          <conditions>
            <check_value value="$actor.iscontrolentity" />
            <check_value value="$actor.owner != faction.player"/>
          </conditions>
          <cues>
            <cue name="ControlEntityHandling" ref="md.GenericMissions.PersistentPlatformActor">
              <param name="BaseCue" value="OnPlatformPopulation_Engineer" />
              <param name="Actor" value="$actor" />
            </cue>
          </cues>
        </cue-->
<!--
Dialogue Tree - rough concept (for all Entity Types)
1. Personal Managment
1.1 Show Skills
1.2 Show Finances (Actor account, Account Owner, Wages and Bonusses) -> also Options for Money Transfer, Account Sharing (and seperation)
1.3 Transfer Entity (not just from/to Skunk, but also tangential as long as its InZone)
1.4 Pester Level (how important should something be before pestering the Player - note that this also depends on the Player Situation) - PLANNED Feature
1.5 
1.6 Go back
2. Settings Managment - Entity Specific
2.1
2.2
2.3
2.4
2.5
2.6
3. Connect to other People   - Maybe also include an Option to connect to Subordinates with no consistent Position (move around as necesary)
      -> note that Station and CV are counted as the same in this Menu
3.1 Defense
3.2 Engineer
3.3 Architect
3.4 Superior
3.5 Captain/Pilot/Manager
3.6 Subordinates
4.
4.1
4.2
4.3
4.4
4.5
4.6
5.
5.1
5.2
5.3
5.4
5.5
5.6
6.
6.1
6.2
6.3
6.4
6.5
6.6
-->

        <cue name="Comm_MainMenu" instantiate="true">
          <conditions>
            <check_any>
              <event_conversation_started actor="$actor"/>
              <event_conversation_returned_to_section actor="$actor" section="default"/>
              <event_cue_signalled/>
            </check_any>
          </conditions>
          <actions>
            <debug_text filter="general" chance="$actor.$debug * 100" text="'%1 %2 %3:\nevent.param= %4 event.param2= %5 event.param3= %6'.[player.age,$actor.name,event.name,event.param,event.param2,event.param3]"/>
            <do_if value="event.name == 'event_conversation_started'">
              <do_if value="$actor.room == player.entity.room">
                <add_npc_line speaker="player.entity" line="[1100,1101].random" hidechoices="false" comment="Hello there. | Hi." />
                <add_npc_line speaker="$actor" line="[1,5,1002,1004].random" hidechoices="false" comment="Hey, there!  | How can I help? | How can I help, Sir? | Hello, Sir. What can I do for you?" />
              </do_if>
              <do_else>
                <add_npc_line speaker="player.entity" line="[1,1100,1101].random" hidechoices="false" comment="This is Otani, channel open. | Hello there. | Hi." />
                <add_npc_line speaker="$actor" line="[1,2,5,1001,1003].random" hidechoices="false" comment="Hey, there! | Comms channel open. | How can I help? | Comms opened, Sir. | Coming in loud and clear. What's the matter?" />
              </do_else>
            </do_if>
            <add_player_choice_sub text="'Lets talk about your Work / Personal Settings'" position="1" section="comm_personal_main"/>
            <add_player_choice_sub text="'Lets talk about your Operating Instructions'" position="2" section="comm_settings_main"/>
            <add_player_choice_sub text="'Connect me with...'" position="3" section="comm_connect_main"/>
            <add_player_choice_sub text="'About your Subordinates...'" position="4" section="comm_subordinates_main" selectable="false"/>
            <add_player_choice_sub text="'DEBUG'" position="5" section="comm_debug_main"/>
            <set_conversation_return_section section="comm_goodbye"/>
            <add_player_choice_return text="'Goodbye'" position="6" />
            <add_player_choice_return text="'Goodbye'" position="close" />
          </actions>
        </cue>
        
        <!-- Menu 1: Personal Settings -->
        <!-- Menu 3: Connect with other Actor-->
        <!-- Menu 4: Subordinates Handling -->
        <!-- Also the Goodbye Section is included here -->
        <!-- (all these Slots are in a shared Lib) -->
        <cue name="Comm_Common" instantiate="true" ref="md.UT_CAC_Lib.Comm_Common">
          <param name="actor" value="$actor"/>
        </cue>
        <!-- Menu 2: Object Settings specific to Captain -->
        <cue name="Comm_Settings" instantiate="true">
          <conditions>
            <check_any>
              <event_conversation_next_section sectionprefix="comm_settings_" actor="$actor"/>
              <event_conversation_returned_to_section sectionprefix="comm_settings_" actor="$actor"/>
            </check_any>
          </conditions>
          <actions>
            <do_if value="event.param == 'comm_settings_main'">
              <do_if value="event.name == 'event_conversation_next_section'">
                <add_npc_line speaker="player.entity" line="[1400,1401,1402].random" hidechoices="false" comment="lets talk about this in detail" />
                <add_npc_line speaker="$actor" line="[4110,4111].random" hidechoices="false" comment="Here you go." />
              </do_if>
              <do_elseif value="event.name == 'event_conversation_returned_to_section'">
                <do_if value="event.param2 == 'no change'">
                  <add_npc_line speaker="player.entity" line="[1220,1410,1612,1713,1714].random" hidechoices="false" comment="No, I changed my mind.|Never mind that, do what you want.|Never mind that, do what you want.|Never mind that.|Well, maybe some other time." />
                </do_if>
                <add_npc_line speaker="$actor" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
              </do_elseif>
              <add_player_choice_sub text="'About your Jumping behavior'" position="1" section="comm_settings_jump" selectable="$actor.skill.navigation gt 3"
                confidence="( @$actor.$jumptype == 'random' ) * 1 + ( @$actor.$jumptype == 'auto' ) * 3 + ( @$actor.$jumptype == 'beacon' ) * 5" comment="confidence shows current Setting: 0 - not set, beacon: 5, Auto: 3, always Random: 1; Selection is only available when Nav Skill is greater than 3" />
              <add_player_choice_return text="'(Back)'" position="6" />
              <add_player_choice_return text="'(Back)'" position="close" />
            </do_if>
            <do_elseif value="event.param == 'comm_settings_jump'">
              <add_npc_line speaker="player.entity" line="[1400,1401,1402].random" hidechoices="false" comment="lets talk about this in detail" />
              <add_npc_line speaker="$actor" line="[4110,4111].random" hidechoices="false" comment="Here you go." />
              <add_player_choice text="'Always use the Jump Beacons'" position="1" section="comm_settings_jump_set" choiceparam="'beacon'" selectable="not ( @$actor.$jumptype == 'beacon' or $actor.$jumptype? )"/>
              <add_player_choice text="'Decide yourself'" position="2" section="comm_settings_jump_set" choiceparam="'auto'" selectable="not ( @$actor.$jumptype == 'auto' )"/>
              <add_player_choice text="'Always make Jumps to a random Object'" position="3" section="comm_settings_jump_set" choiceparam="'random'" selectable="not ( @$actor.$jumptype == 'random' )"/>
              <add_player_choice_return text="'(Back)'" position="6" />
              <add_player_choice_return text="'(Back)'" position="close" />
            </do_elseif>
            <do_elseif value="event.param == 'comm_settings_jump_set'">
              <add_npc_line speaker="$actor" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
              <set_value name="$actor.$jumptype" exact="event.param2"/>
            </do_elseif>
          </actions>
        </cue>
        
        <cue name="NPC_Destroyed">
          <conditions>
            <event_object_destroyed object="$actor"/>
          </conditions>
          <!--delay exact="1s" comment="delay as the PlatformActor library may also take care of this"/ currently not included, so commented out -->
          <actions>
            <debug_text text="'NPC_Destroyed'"/>
            <cancel_cue cue="Main"/>
          </actions>
        </cue>
        
      </cues>
    </cue>

  </cues>

</mdscript>
